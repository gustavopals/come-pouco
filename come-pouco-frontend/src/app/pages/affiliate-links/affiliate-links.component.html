<section class="page-shell">
  <mat-toolbar color="primary" class="app-toolbar">
    <strong>Come Pouco</strong>
    <span class="toolbar-spacer"></span>
    <a mat-button routerLink="/home" routerLinkActive="nav-link-active">Home</a>
    <a mat-button routerLink="/users" routerLinkActive="nav-link-active">Usuários</a>
    <a mat-button routerLink="/affiliate-links" routerLinkActive="nav-link-active">Links Afiliados</a>
    <button mat-flat-button color="warn" type="button" (click)="logout()">Sair</button>
  </mat-toolbar>

  <main class="page-main admin-grid">
    <mat-card appearance="outlined" class="form-card">
      <mat-card-header>
        <mat-card-title>{{ isCreateMode() ? 'Cadastro de links de afiliados' : 'Editar link de afiliado' }}</mat-card-title>
        <mat-card-subtitle>Controle links, criativos e chamadas de conversão.</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="form" (ngSubmit)="submit()" class="entity-form">
          <div class="field-grid">
            <mat-form-field appearance="outline">
              <mat-label>Link original</mat-label>
              <input matInput type="url" formControlName="originalLink" placeholder="https://..." />
              <mat-error *ngIf="form.controls.originalLink.touched && form.controls.originalLink.invalid">
                O link original é obrigatório.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Imagem do produto</mat-label>
              <input matInput type="url" formControlName="productImage" placeholder="https://..." />
              <mat-error *ngIf="form.controls.productImage.touched && form.controls.productImage.invalid">
                A URL da imagem é obrigatória.
              </mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Frase chamativa</mat-label>
            <textarea matInput rows="3" formControlName="catchyPhrase" placeholder="Texto de venda"></textarea>
            <mat-error *ngIf="form.controls.catchyPhrase.touched && form.controls.catchyPhrase.invalid">
              A frase deve ter pelo menos 4 caracteres.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Link afiliado</mat-label>
            <input matInput type="url" formControlName="affiliateLink" placeholder="https://..." />
            <mat-error *ngIf="form.controls.affiliateLink.touched && form.controls.affiliateLink.invalid">
              O link afiliado é obrigatório.
            </mat-error>
          </mat-form-field>

          <div class="entity-actions">
            <button mat-flat-button color="primary" type="submit" [disabled]="isSaving">
              {{ isSaving ? 'Salvando...' : (isCreateMode() ? 'Cadastrar' : 'Salvar alterações') }}
            </button>
            <button mat-stroked-button type="button" *ngIf="!isCreateMode()" (click)="cancelEdit()">
              Cancelar edição
            </button>
          </div>
        </form>

        <p class="status-block status-error" *ngIf="errorMessage">{{ errorMessage }}</p>
        <p class="status-block status-success" *ngIf="successMessage">{{ successMessage }}</p>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined" class="table-card">
      <mat-card-header class="table-header">
        <div>
          <mat-card-title>Registros cadastrados</mat-card-title>
          <mat-card-subtitle>{{ totalLinks }} registro(s)</mat-card-subtitle>
        </div>
        <div class="toolbar-spacer"></div>
        <button mat-stroked-button type="button" (click)="loadLinks()">Atualizar</button>
      </mat-card-header>

      <mat-card-content>
        <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

        <div class="table-shell" *ngIf="!isLoading && links.length">
          <table mat-table [dataSource]="links" class="data-table">
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let link"><span class="id-pill">#{{ link.id }}</span></td>
            </ng-container>

            <ng-container matColumnDef="productImage">
              <th mat-header-cell *matHeaderCellDef>Imagem</th>
              <td mat-cell *matCellDef="let link">
                <img [src]="link.productImage" alt="Produto" class="thumb" />
              </td>
            </ng-container>

            <ng-container matColumnDef="catchyPhrase">
              <th mat-header-cell *matHeaderCellDef>Frase</th>
              <td mat-cell *matCellDef="let link" class="strong-cell">{{ link.catchyPhrase }}</td>
            </ng-container>

            <ng-container matColumnDef="originalLink">
              <th mat-header-cell *matHeaderCellDef>Link original</th>
              <td mat-cell *matCellDef="let link">
                <a [href]="link.originalLink" target="_blank" rel="noreferrer">Abrir</a>
              </td>
            </ng-container>

            <ng-container matColumnDef="affiliateLink">
              <th mat-header-cell *matHeaderCellDef>Link afiliado</th>
              <td mat-cell *matCellDef="let link">
                <a [href]="link.affiliateLink" target="_blank" rel="noreferrer">Abrir</a>
              </td>
            </ng-container>

            <ng-container matColumnDef="updatedAt">
              <th mat-header-cell *matHeaderCellDef>Atualizado em</th>
              <td mat-cell *matCellDef="let link">{{ link.updatedAt | date: 'dd/MM/yyyy HH:mm' }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Ações</th>
              <td mat-cell *matCellDef="let link" class="row-actions">
                <button mat-stroked-button type="button" (click)="startEdit(link)">Editar</button>
                <button mat-flat-button color="warn" type="button" (click)="remove(link)">Excluir</button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>

        <p class="empty-state" *ngIf="!isLoading && !links.length">Nenhum link cadastrado.</p>
      </mat-card-content>
    </mat-card>
  </main>
</section>
